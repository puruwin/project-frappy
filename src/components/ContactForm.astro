---
interface Props {
  formId?: string;
  className?: string;
  title?: string;
  description?: string;
  showWhatsApp?: boolean;
  variant?: "default" | "transparent";
}

const {
  formId = "contactForm",
  className = "",
  title = "¿Hablamos de tu proyecto?",
  description = "Cuéntanos sobre tu proyecto y nos pondremos en contacto contigo lo antes posible.",
  showWhatsApp = true,
  variant = "default",
} = Astro.props;

const FORM_ENDPOINT = "https://formspree.io/f/mjkglyjd";

// Estilos según variante
const containerClass = variant === "transparent" 
  ? "rounded-3xl bg-white/10 p-6 shadow-2xl backdrop-blur-md sm:p-8"
  : "bg-[var(--color-background-offset)] rounded-lg p-4 sm:p-6";

const titleClass = variant === "transparent"
  ? "mb-4 font-bold text-[#111827] text-2xl sm:text-3xl"
  : "mb-4 font-sans font-bold text-white text-base sm:mb-5 sm:text-lg";

const descriptionClass = variant === "transparent"
  ? "mb-6 text-[#111827]/90 text-base"
  : "mb-4 font-sans text-white/90 text-sm sm:mb-5";

const labelClass = variant === "transparent"
  ? "mb-2 block font-medium text-[#111827] text-sm"
  : "mb-1 block font-sans text-white/90 text-xs sm:mb-1.5 sm:text-sm";

const inputClass = variant === "transparent"
  ? "w-full rounded-lg border-2 border-white/30 bg-white/90 p-3 font-sans text-gray-900 transition-all text-sm placeholder:text-gray-500 focus:border-white focus:bg-white focus:outline-none focus:ring-2 focus:ring-white/50"
  : "placeholder:text-[var(--color-text-offset)]/60 w-full rounded-t-md border-b-2 border-[var(--color-primary)] bg-white p-2 font-sans transition-colors text-sm focus:border-[var(--color-secondary)] focus:outline-none sm:p-2.5";

const textareaClass = variant === "transparent"
  ? "w-full resize-none rounded-lg border-2 border-white/30 bg-white/90 p-3 font-sans text-gray-900 transition-all text-sm placeholder:text-gray-500 focus:border-white focus:bg-white focus:outline-none focus:ring-2 focus:ring-white/50"
  : "placeholder:text-[var(--color-text-offset)]/60 w-full resize-none rounded-t-md border-b-2 border-[var(--color-primary)] bg-white p-2 font-sans transition-colors text-sm focus:border-[var(--color-secondary)] focus:outline-none sm:p-2.5";

const checkboxClass = variant === "transparent"
  ? "mt-1 h-4 w-4 rounded border-2 border-white bg-white/90 text-[#29c1f1] focus:ring-2 focus:ring-white focus:ring-offset-0"
  : "mt-1 h-4 w-4 rounded border-2 border-[var(--color-primary)] bg-white text-[var(--color-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--color-secondary)]";

const checkboxLabelClass = variant === "transparent"
  ? "flex cursor-pointer items-start gap-2 font-sans text-[#111827] text-sm"
  : "flex cursor-pointer items-start gap-2 font-sans text-white/90 text-xs sm:text-sm";

const buttonClass = variant === "transparent"
  ? "flex-1 rounded-xl bg-white px-6 py-3 font-bold text-[#29c1f1] shadow-xl transition-all hover:scale-105 hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-white/50 disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:scale-100"
  : "flex-1 rounded-md bg-[var(--color-secondary)] px-6 py-2 font-sans text-[var(--color-text)] transition-colors text-sm hover:bg-white/90 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-[var(--color-secondary)] disabled:cursor-not-allowed disabled:bg-white/20 disabled:text-white/60 sm:py-2.5";

const whatsappButtonClass = variant === "transparent"
  ? "flex flex-1 items-center justify-center gap-2 rounded-xl bg-[#25D366] px-6 py-3 font-bold text-white shadow-xl transition-all hover:scale-105 hover:bg-[#25D366]/90 focus:outline-none focus:ring-4 focus:ring-[#25D366]/50"
  : "flex-1 rounded-md bg-[#25D366] px-6 py-2 text-center font-sans text-white transition-colors text-sm hover:bg-[#25D366]/90 hover:text-white focus:outline-none focus:ring-2 focus:ring-[#25D366] focus:ring-offset-2 focus:ring-offset-[var(--color-secondary)] sm:py-2.5";
---

<div class={`${containerClass} ${className}`}>
  <h3 class={titleClass}>
    {title}
  </h3>

  <p class={descriptionClass}>
    {description}
  </p>

  <form
    action={FORM_ENDPOINT}
    method="POST"
    id={formId}
    class="grid grid-cols-1 gap-4"
  >
    <div>
      <label
        class={labelClass}
        for={`${formId}-name`}
      >
        Nombre
      </label>
      <input
        type="text"
        id={`${formId}-name`}
        name="name"
        required
        class={inputClass}
        placeholder="Tu nombre"
      />
    </div>

    <div>
      <label
        class={labelClass}
        for={`${formId}-email`}
      >
        Correo Electrónico
      </label>
      <input
        type="email"
        id={`${formId}-email`}
        name="email"
        required
        class={inputClass}
        placeholder="tu@email.com"
      />
    </div>

    <input type="text" name="_gotcha" style="display:none" />

    <div>
      <label
        class={labelClass}
        for={`${formId}-phone`}
      >
        Teléfono
      </label>
      <input
        type="tel"
        id={`${formId}-phone`}
        name="phone"
        required
        class={inputClass}
        placeholder="600 000 000"
      />
    </div>

    <div>
      <label
        class={labelClass}
        for={`${formId}-message`}
      >
        Cuéntanos sobre tu proyecto
      </label>
      <textarea
        id={`${formId}-message`}
        name="message"
        rows={variant === "transparent" ? "3" : "2"}
        required
        class={textareaClass}
        placeholder="Describe brevemente tu proyecto..."></textarea>
    </div>

    <div>
      <label class={checkboxLabelClass}>
        <input
          type="checkbox"
          id={`${formId}-privacy`}
          name="privacy"
          required
          class={checkboxClass}
        />
        <span class="leading-tight">
          He leído y acepto la
          <a
            href="/privacidad"
            target="_blank"
            rel="noopener noreferrer"
            class={variant === "transparent" 
              ? "font-bold underline hover:text-[#111827]/80"
              : "rounded text-[var(--color-secondary)] underline hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-[var(--color-background-offset)]"
            }
          >
            Política de Privacidad
          </a>
          *
        </span>
      </label>
    </div>

    <div class={variant === "transparent" ? "mt-2 flex flex-col gap-3 sm:flex-row" : "mt-1 flex flex-col gap-2 sm:mt-2 sm:flex-row sm:gap-3"}>
      <button
        id={`${formId}SubmitButton`}
        type="submit"
        class={buttonClass}
        disabled
      >
        {variant === "transparent" ? "Enviar propuesta" : "Enviar"}
      </button>

      {
        showWhatsApp && (
          <a
            href="https://wa.me/+34608962213"
            target="_blank"
            rel="noopener noreferrer"
            class={whatsappButtonClass}
          >
            {variant === "transparent" ? (
              <>
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884"></path>
                </svg>
                WhatsApp
              </>
            ) : (
              "Escríbenos por WhatsApp"
            )}
          </a>
        )
      }
    </div>
  </form>
</div>

<script define:vars={{ formId }}>
  const form = document.getElementById(formId);

  const submitButton = document.getElementById(`${formId}SubmitButton`);

  const requiredInputs = form?.querySelectorAll(
    `#${formId} input[required], #${formId} textarea[required]`,
  );

  // Deshabilitar el botón inicialmente
  if (submitButton) {
    submitButton.disabled = true;
  }

  // Función para verificar que todos los campos requeridos estén completos
  function checkFormValidity() {
    if (!requiredInputs) return false;
    const privacyCheckbox = document.getElementById(`${formId}-privacy`);
    const fieldsValid = Array.from(requiredInputs).every(
      (input) => input.value.trim() !== "",
    );
    const privacyValid = privacyCheckbox ? privacyCheckbox.checked : false;
    const isValid = fieldsValid && privacyValid;
    return isValid;
  }

  // Validar en tiempo real
  requiredInputs?.forEach((input) => {
    input.addEventListener("input", () => {
      if (submitButton) {
        const isValid = checkFormValidity();
        submitButton.disabled = !isValid;
      }
    });
  });

  // Validar checkbox de privacidad en tiempo real
  const privacyCheckbox = document.getElementById(`${formId}-privacy`);
  privacyCheckbox?.addEventListener("change", () => {
    if (submitButton) {
      const isValid = checkFormValidity();
      submitButton.disabled = !isValid;
    }
  });

  // Manejar envío del formulario
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    submitButton.disabled = true;
    submitButton.textContent = "Enviando...";

    try {
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: "POST",
        body: formData,
        headers: {
          Accept: "application/json",
        },
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(
          `Error al enviar el formulario: ${data.error || response.statusText}`,
        );
      }

      const data = await response.json();

      if (data.ok) {
        form.reset();
        document.getElementById("successModal")?.classList.remove("hidden");
        // Mantener el botón deshabilitado después de un envío exitoso
        submitButton.disabled = true;
        // @ts-ignore
        window.dataLayer?.push({
          event: "form_submit",
          form_name: formId,
          form_status: "success",
        });
      } else {
        throw new Error("Error al enviar el formulario");
      }
    } catch (error) {
      console.error("Error:", error);
      document.getElementById("errorModal")?.classList.remove("hidden");
      // En caso de error, habilitar el botón para reintentar
      submitButton.disabled = false;
      // @ts-ignore
      window.dataLayer?.push({
        event: "form_submit",
        form_name: formId,
        form_status: "error",
      });
    } finally {
      submitButton.textContent = "Enviar";
    }
  });
</script>

